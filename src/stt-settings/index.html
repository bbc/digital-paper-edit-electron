<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,shrink-to-fit=no"
    />
    <meta name="theme-color" content="#000000" />
    <link rel="stylesheet" href="../../node_modules/bootstrap-css-only/css/bootstrap.min.css">
    <!-- <link rel="manifest" href="./manifest.json" /> -->
    <title>Digital Paper Edit - Settings</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script> -->
    <script src="./babel.min.js"></script>
  </head>
  <body>
      <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <script type="text/babel">
    import React from 'react';
    import ReactDOM from 'react-dom';
    import Container from 'react-bootstrap/Container';
    import Breadcrumb from 'react-bootstrap/Breadcrumb';
    import Nav from 'react-bootstrap/Nav';
    import Tabs from 'react-bootstrap/Tabs';
    import Tab from 'react-bootstrap/Tab';
    import Button from 'react-bootstrap/Button';
    import Form from 'react-bootstrap/Form';

    import { getDefaultStt, setDefaultStt } from './default-stt.js';
    import speechmaticsLanguages from './language-options/speechmatics.json';
    const {app} = require('electron').remote;
    const appVersion = app.getVersion();


    class SelectDefaultStt extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          defaultStt: '',
          defaultLanguage: 'en-GB'
        }
      }

      componentDidMount(){
        const { provider, language } = getDefaultStt();
        console.log('provider, language',provider, language)
        this.setState({
          defaultStt: provider,
          defaultLanguage: language
        })
      }
      handleChangeDefaultStt = (e)=>{
        console.log(e, e.target.value)
        this.setState({
          defaultStt: e.target.value,
          saved: false
        })
      }

      handleChangeDefaultLanguage = (e) =>{
        this.setState({
          defaultLanguage: e.target.value,
          saved: false
        })

       
      }

      handleSave = ()=>{
        setDefaultStt({ 
          language: this.state.defaultLanguage,
          provider: this.state.defaultStt
        })
        this.setState({
          saved: true
        })
      }

      render() {
        let languagesOptions = [<option value='' key='default' disabled></option>]
        if(this.state.defaultStt ==='AssemblyAI'){
          languagesOptions = [<option value='en' key='en' disabled>English</option>]
        }
        if(this.state.defaultStt === 'Speechmatics'){
          languagesOptions = speechmaticsLanguages.map((language, index)=>{
          return (<option key={language.code} value={language.code}>{language.language}</option>);
        })
        }
       
        return (
          <div>
            {this.state.saved?  <p className={'text-success'}>Saved {this.state.defaultStt} and {this.state.defaultLanguage} as defaults!</p>:null}
            <br/>
            <h3>Default STT</h3>
            <br/>
          <Form.Group controlId="exampleForm.ControlSelect1">
            <Form.Label>Default Speech To Text engine</Form.Label>
            <Form.Control 
              as="select" 
              value={this.state.defaultStt}
              onChange={this.handleChangeDefaultStt}
              >
              <option value='AssemblyAI'>AssemblyAI</option>
              <option value='Speechmatics'>Speechmatics</option>
              <option value='Google' disabled>Google STT</option>
              <option value='IBM' disabled>IBM STT</option>
              <option value='Amazon' disabled>Amazon Transcribe</option>
              <option value='BBC'>BBC</option>
              <option value='' disabled></option>
            </Form.Control>
            <Form.Text className="text-muted">
             Choose the default STT you would like to use for your transcriptions
            </Form.Text>
          </Form.Group>

          {this.state.defaultStt !== 'BBC' && this.state.defaultStt !== 'AssemblyAI'? <Form.Group  controlId="exampleForm.ControlSelect1">
            <Form.Label>Default Speech To Text language</Form.Label>
            <Form.Control 
              as="select" 
              value={this.state.defaultLanguage}
              onChange={this.handleChangeDefaultLanguage}
              >
              {languagesOptions}
            </Form.Control>
            <Form.Text className="text-muted">
             Choose the default STT language you would like to use for your transcriptions
            </Form.Text>
          </Form.Group> :  ( <React.Fragment><Form.Label>Default Speech To Text language</Form.Label>
          <Form.Text className="text-muted">Only English available as default </Form.Text> </React.Fragment>)}
            <br/>
          <Button onClick={this.handleSave}  variant="outline-primary" block>Save default configuration</Button>
          </div>
        )
      }
    }

    class SettingsForm extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
            sttUserName: this.props.sttUserName,
            sttAPIKey: this.props.sttAPIKey,
            sttAPIUrl: this.props.sttAPIUrl
        }
      }

        handlesttUserNameChange = (event)=>{
          this.setState({ sttUserName: event.target.value });
        }
        handleSTTAPIKeyChange = (event)=>{
          this.setState({ sttAPIKey: event.target.value });
        }

        handleSTTAPIUrlChange = (event) =>{
          this.setState({ sttAPIUrl: event.target.value });
        }

        handleSubmit(event) {
          const form = event.currentTarget;
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
            this.setState({ validated: true });
          }

          if (form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
            const tmpItem = {
              provider: this.props.provider,
              sttUserName: this.state.sttUserName,
              sttAPIKey: this.state.sttAPIKey,
              sttAPIUrl: this.state.sttAPIUrl
            };
            this.props.handleSave(tmpItem);
          }
          //this.setState({ redirect: true, newProjectId: response.projectId });
        }
          render() {
            console.log('SettingsForm-this.state.sttUserName', this.state.sttUserName)
              return (<div>
                  <h4> {this.props.provider} service credentials</h4>
                  <Form
                  noValidate
                  validated={ this.state.validated }
                  onSubmit={ e => this.handleSubmit(e) }
                  >

                  <Form.Text className="text-muted">
                     {this.props.customInstructions}
                    </Form.Text>
          
                {this.state.sttUserName !== false? <Form.Group controlId="sttUserName">
                    <Form.Label>{this.props.provider ==='BBC'? 'BBC work email':`${this.props.provider} STT Username`} </Form.Label>
                    <Form.Control 
                    type="text" 
                    placeholder={this.props.provider ==='BBC'?  'Enter your BBC email address name.lastname@bbc.co.uk' :"Enter the STT Username" }
                    value={ this.state.sttUserName }
                    // defaultValue={ this.state.sttUserName }
                    onChange={ this.handlesttUserNameChange }
                    required
                    />
                    <Form.Text className="text-muted">
                    {this.props.provider ==='BBC'?  'Use your BBC email address name.lastname@bbc.co.uk'
                    : `Note that ${this.props.provider}  Speech To Text username is different from your ${this.props.provider} account login` }
                    </Form.Text>
                    <Form.Control.Feedback>Looks good!</Form.Control.Feedback>
                    <Form.Control.Feedback type="invalid">
                        Please add the Speech To Text Username
                    </Form.Control.Feedback>
                  </Form.Group> 
                  :null}

                  {this.state.sttAPIKey !== false ? <Form.Group controlId="sttAPIKey">
                    <Form.Label>API Key</Form.Label>
                    <Form.Control
                      type="text"
                      placeholder="Enter the API Key"
                      value={ this.state.sttAPIKey }
                      // defaultValue={ this.state.sttAPIKey }
                      onChange={ this.handleSTTAPIKeyChange }
                     required
                    />
                    <Form.Text className="text-muted">
                     API Key provided by {this.props.provider} 
                    </Form.Text>
                    <Form.Control.Feedback>Looks good!</Form.Control.Feedback>
                    <Form.Control.Feedback type="invalid">
                        Please add the Speech To Text API Key
                    </Form.Control.Feedback>
                  </Form.Group>
                  :null}

                  {this.state.sttAPIUrl !== false ? 
                  <Form.Group controlId="sttAPIUrl">
                    <Form.Label>API URL</Form.Label>
                    <Form.Control
                      type="text"
                      placeholder="Enter the STT API URL"
                      value={ this.state.sttAPIUrl }
                      // defaultValue={ this.state.sttAPIUrl }
                      onChange={ this.handleSTTAPIUrlChange }
                     required
                    />
                    <Form.Text className="text-muted">
                     API Key provided by {this.props.provider} 
                    </Form.Text>
                    <Form.Control.Feedback>Looks good!</Form.Control.Feedback>
                    <Form.Control.Feedback type="invalid">
                        Please add the Speech To Text API Key
                    </Form.Control.Feedback>
                  </Form.Group>
                  :null}

                 
                  {/* on change save - send to server as post + link to projects list? */}
                  <Button 
                  variant="outline-primary" type="submit" block>
                    Save {this.props.provider} credentials
                  </Button>
                </Form>
                </div>);
          }
      }

      import {getCredentials, setCredentials} from './credentials.js';
      class Settings extends React.Component {
        constructor(props) {
        super(props);
          this.state = {
            saved: false,
            bbcSttUserName: false,
            speechmaticsSTTUsername: false,
            speechmaticsApiKey: false,
            assemblyAISttAPIKey: false,
            currentSavedProvider: ''
          }
        }

        componentDidMount = () =>{
          const bbcCredentials = getCredentials('BBC');
          console.log('bbcCredentials', bbcCredentials);
          const speechmaticsCredentials = getCredentials('Speechmatics');
          // console.log('speechmaticsCredentials', speechmaticsCredentials);
          const assemblyAiCred = getCredentials('AssemblyAI');
          // console.log('AssemblyAICredentials',AssemblyAICredentials)

          this.setState({
            bbcSttUserName: bbcCredentials.sttUserName,
            speechmaticsSTTUsername: speechmaticsCredentials.sttUserName,
            speechmaticsApiKey: speechmaticsCredentials.sttAPIKey,
            assemblyAISttAPIKey: assemblyAiCred.sttAPIKey
          }, ()=>{
            console.log('state set', this.state.bbcSttUserName);
            this.forceUpdate();
          })
        }

        handleSave = (data) => {
          setCredentials(data)
          // Todo consider adding some error handling
          this.setState({ 
            saved: true,
            currentSavedProvider: data.provider
          })
        }

          render() {
              return (
               <Container>
                  <br/>
                 
                  <Breadcrumb>
                    <Breadcrumb.Item active>Settings - v{appVersion}</Breadcrumb.Item>
                  </Breadcrumb>

                  
                  <Tabs  defaultActiveKey={'defaultStt'}>
                    <Tab eventKey="defaultStt" title="Default STT">
                      <SelectDefaultStt />
                    </Tab>
                    <Tab eventKey="settings" title="Settings">
                      {this.state.saved?  <p className={'text-success'}>Saved {this.state.currentSavedProvider} credentials!</p>:null}

                      <br/>
                      <h3>STT Settings</h3>
                      <br/>
                      <Tabs defaultActiveKey="assemblyai">
                     {/* <Tab eventKey="ibm" title="IBM" disabled>
                        <SettingsForm 
                          sttUserName={false}
                          sttAPIKey={'tbc2'}
                          sttAPIUrl={'tbc3'}
                          provider={'IBM'}
                          handleSave={this.handleSave}
                          />
                     </Tab>*/}
                     {this.state.assemblyAISttAPIKey!== false? 
                      <Tab eventKey="assemblyai" title="AssemblyAI">
                        <SettingsForm 
                          sttUserName={false}
                          sttAPIKey={this.state.assemblyAISttAPIKey}
                          sttAPIUrl={false}
                          provider={'AssemblyAI'}  
                          handleSave={this.handleSave}
                          />
                      </Tab>: null}

                      {this.state.speechmaticsSTTUsername !== false 
                      && this.state.speechmaticsApiKey !== false ?
                      <Tab eventKey="speechmatics" title="Speechmatics">
                        <SettingsForm 
                          sttUserName={this.state.speechmaticsSTTUsername}
                          sttAPIKey={this.state.speechmaticsApiKey}
                          sttAPIUrl={false}
                          provider={'Speechmatics'} 
                          handleSave={this.handleSave}
                          />
                      </Tab>:null}
                     {/* <Tab eventKey="rev" title="Rev" disabled>
                        <SettingsForm 
                          sttUserName={'tbc1'}
                          sttAPIKey={'tbc2'}
                          sttAPIUrl={'tbc3'}
                          provider={'Rev'}  
                          handleSave={this.handleSave}
                          />
                      </Tab> 
                      <Tab eventKey="amazon" title="Amazon" disabled>
                        <SettingsForm 
                          sttUserName={'tbc1'}
                          sttAPIKey={'tbc2'}
                          sttAPIUrl={'tbc3'}
                          provider={'Amazon Transcribe'}  
                          handleSave={this.handleSave}
                          />
                      </Tab>
                      <Tab eventKey="google" title="Google" disabled>
                        <SettingsForm 
                          sttUserName={'tbc1'}
                          sttAPIKey={'tbc2'}
                          sttAPIUrl={'tbc3'}
                          provider={'Google Cloud STT'}  
                          handleSave={this.handleSave}
                          />
                      </Tab>*/}
                      {this.state.bbcSttUserName!== false? 
                      <Tab eventKey="bbc" title="BBC">
                        <SettingsForm  
                          sttUserName={this.state.bbcSttUserName}
                          sttAPIKey={false}
                          sttAPIUrl={false}
                          provider={'BBC'} 
                          handleSave={this.handleSave}
                          customInstructions={<div><p>This service only works for BBC employee while on the BBC network. </p><p>In order to use this service add your BBC work email address here.</p></div>}
                        />
                      </Tab>
                      : null}
                    </Tabs>

                  </Tab>
                </Tabs>
              </Container> );
          }
      }
      ReactDOM.render(
          <Settings />,
          document.getElementById('root')
      );
      </script>
  </body>
</html>
